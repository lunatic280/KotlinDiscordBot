name: deploy-bot

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod_bot

    steps:
      - name: Clone repo
        run: |
          git clone "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" .
          git checkout "${{ github.sha }}"

      - name: Set up JDK 21
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-21-jdk

      - name: Build bootJar
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test
          JAR_PATH=$(ls -1t build/libs/*.jar | head -n 1)
          echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV

      # ✅ GitHub-hosted runner를 Tailnet에 연결 (배포 시간 동안만)
      - name: Connect to Tailscale
        uses: tailscale/github-action@53acf823325fe9ca47f4cdaa951f90b4b0de5bb9
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      # ✅ DEPLOY_HOST(Tailscale IP)에 대한 known_hosts 자동 생성
      - name: Add host to known_hosts
        run: |
          ssh-keyscan -H "${{ vars.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Upload jar
        run: |
          scp -i ~/.ssh/id_ed25519 \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -P "${{ vars.DEPLOY_PORT }}" \
              "${{ env.JAR_PATH }}" \
              "${{ vars.DEPLOY_USER }}@${{ vars.DEPLOY_HOST }}:/tmp/app.jar"

      - name: Update server runtime env
        run: |
          ssh -i ~/.ssh/id_ed25519 \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p "${{ vars.DEPLOY_PORT }}" \
              "${{ vars.DEPLOY_USER }}@${{ vars.DEPLOY_HOST }}" \
              "tmp=\$(mktemp) && \
              (grep -v '^PUBG_API_KEY=' /etc/discordbot.env 2>/dev/null || true) > \$tmp && \
              printf '%s\n' 'PUBG_API_KEY=${{ secrets.PUBG_API_KEY }}' >> \$tmp && \
              install -m 600 \$tmp /etc/discordbot.env && \
              rm -f \$tmp"

      - name: Deploy & restart discordbot
        run: |
          ssh -i ~/.ssh/id_ed25519 \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p "${{ vars.DEPLOY_PORT }}" \
              "${{ vars.DEPLOY_USER }}@${{ vars.DEPLOY_HOST }}" \
              "sudo /usr/local/bin/deploy-discordbot /tmp/app.jar"
